<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>跨设备 Google 授权 - 电脑端</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database-compat.js"></script>
    <!-- Google Identity Services (GIS) client library - not strictly needed for desktop but for consistency -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/client": "https://esm.sh/react-dom@^19.1.0/client",
    "qrcode.react": "https://esm.sh/qrcode.react@^4.2.0"
  }
}
</script>
    <style>
      body { margin: 0; font-family: sans-serif; }
      .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(10px); } 
        to { opacity: 1; transform: translateY(0); } 
      }
      .error-message-container {
        padding: 20px; margin: 20px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px; font-family: sans-serif;
      }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="module">
      import React, { useState, useEffect, useCallback, StrictMode } from 'react';
      import ReactDOM from 'react-dom/client';
      import { QRCodeCanvas } from 'qrcode.react';

      // --- START OF INLINED types.ts ---
      var AuthStatus;
      (function (AuthStatus) {
          AuthStatus["PENDING"] = "pending"; 
          AuthStatus["AUTHORIZED"] = "authorized"; 
          AuthStatus["TOKEN_RECEIVED"] = "token_received"; 
          AuthStatus["FETCHING_USER"] = "fetching_user"; 
          AuthStatus["USER_INFO_LOADED"] = "user_info_loaded"; 
          AuthStatus["ERROR"] = "error"; 
          AuthStatus["LOGGED_OUT"] = "logged_out"; 
          AuthStatus["SESSION_EXPIRED"] = "session_expired"; 
          AuthStatus["INITIALIZING"] = "initializing"; 
      })(AuthStatus || (AuthStatus = {}));
      // --- END OF INLINED types.ts ---

      // --- START OF INLINED constants.tsx ---
      const FIREBASE_CONFIG = {
            apiKey: "AIzaSyArF8xncLwA3osSQ_o6yWIyuOc0TMrXRTY",
            authDomain: "yingpei--login.firebaseapp.com",
            databaseURL: "https://yingpei--login-default-rtdb.firebaseio.com",
            projectId: "yingpei--login",
            storageBucket: "yingpei--login.firebasestorage.app",
            messagingSenderId: "261477282402",
            appId: "1:261477282402:web:557f0be058e07cd642173b",
            measurementId: "G-EB9PR17TJL"
      };
      const GOOGLE_CLIENT_ID = "130403455153-cdmr57ri7qh3s6c8riul6q6hsi3arjf8.apps.googleusercontent.com"; // <--- 在此修改 Google Client ID
      const FB_AUTH_PATH = 'authorizations';
      const APP_TITLE = "跨设备 Google 授权";
      const DESKTOP_PAGE_TITLE = "电脑端操作界面";
      
      const UI_TEXT = {
          scanQrCode: "请使用手机扫描下方二维码进行 Google 授权：",
          authStatus: "授权状态",
          statusInitializing: "初始化中...",
          statusPending: "等待手机端授权...",
          statusTokenReceived: "令牌已接收，验证中...",
          statusAuthorized: "授权成功", // Note: This status is usually transient on desktop before fetching user.
          statusFetchingUser: "正在获取用户 Google 资料...",
          statusUserInfoLoaded: "用户信息加载成功",
          statusError: "授权失败",
          statusLoggedOut: "已登出。请重新授权。",
          statusSessionExpired: "会话已过期或无效，请重新授权。",
          fetchUserInfoError: "获取用户信息失败，请检查令牌或网络连接。",
          googleServices: "Google 服务",
          logout: "退出登录",
          reauthorize: "重新授权",
          scanQrOnComputer: "请扫描电脑屏幕上的二维码",
          orEnterSessionId: "或手动输入 Session ID (如果二维码无法扫描)",
          sessionIdInputLabel: "Session ID",
          startScan: "开始扫描二维码",
          stopScan: "停止扫描",
          loginWithGoogle: "使用 Google 登录授权",
          authorizing: "正在授权...",
          authSuccessMobile: "授权成功！请返回电脑端查看。",
          authErrorMobile: "授权失败，请重试。",
          qrScannerError: "二维码扫描器初始化失败。",
          qrScanPrompt: "将二维码置于框内扫描",
          invalidSessionId: "无效的 Session ID。请确保从电脑端获取正确的二维码或 Session ID。",
          firebaseConnectionError: "无法连接到 Firebase。请检查您的网络连接和 Firebase 配置。",
          tokenEncryptionNote: "提示：为提高安全性，实际应用中令牌应在传输和存储时加密。",
          viewOnDesktop: "请在电脑端查看授权结果。",
          userProfile: "用户资料",
          name: "姓名",
          email: "邮箱",
          id: "用户ID",
      };

      const GmailIcon = (props) => (React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor", ...props }, React.createElement("path", { d: "M2.003 5.5A2.5 2.5 0 0 1 4.5 3h15A2.5 2.5 0 0 1 22 5.5v1A2.5 2.5 0 0 1 19.5 9h-15A2.5 2.5 0 0 1 2 6.5v-1Z" }), React.createElement("path", { d: "M2.003 9.5A2.5 2.5 0 0 1 4.5 7h15a2.5 2.5 0 0 1 2.5 2.5v7A2.5 2.5 0 0 1 19.5 21h-15A2.5 2.5 0 0 1 2 18.5v-9ZM12 10.75a.75.75 0 0 0-.621.344l-3.156 4.975A2.502 2.502 0 0 1 4.5 17h15a2.5 2.5 0 0 1-3.723-1.93l-3.156-4.976A.75.75 0 0 0 12 10.75Z" })));
      const DriveIcon = (props) => (React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor", ...props }, React.createElement("path", { d: "M7.73 2.004A2.25 2.25 0 0 1 9.312 1.5h5.376a2.25 2.25 0 0 1 1.582.504l6.001 3.999a2.25 2.25 0 0 1 .825 1.913l-1.604 9.622a2.25 2.25 0 0 1-2.164 1.962H4.672a2.25 2.25 0 0 1-2.164-1.962L.904 7.92a2.25 2.25 0 0 1 .825-1.913L7.73 2.004ZM9.938 3H9.31C8.79 3 8.41 3.174 8.16 3.423l-6 4c-.25.167-.345.37-.307.558L3.42 17.52c.039.233.23.402.468.402h16.224c.237 0 .43-.169.468-.402l1.567-9.539c.038-.188-.057-.391-.307-.558l-6-4C15.59 3.174 15.209 3 14.689 3h-.625L9.937 3Z" }), React.createElement("path", { d: "m13.082 10.22 4.58-2.748L12 3.186 6.338 7.472l4.58 2.748a2.25 2.25 0 0 0 2.164 0Z" })));
      const CalendarIcon = (props) => (React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor", ...props }, React.createElement("path", { fillRule: "evenodd", d: "M5.25 2.25A.75.75 0 0 1 6 3v.75h12V3a.75.75 0 0 1 1.5 0v.75h.75a3 3 0 0 1 3 3v11.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V6.75a3 3 0 0 1 3-3H6V3a.75.75 0 0 1 .75-.75Zm13.5 9H5.25V18a1.5 1.5 0 0 0 1.5 1.5h10.5a1.5 1.5 0 0 0 1.5-1.5v-6.75Z", clipRule: "evenodd" })));
      const DocsIcon = (props) => (React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor", ...props }, React.createElement("path", { d: "M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 16.5 9h-1.875a.375.375 0 0 1-.375-.375V6.75A3.75 3.75 0 0 0 10.5 3H5.625Zm1.5 10.5a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5h-6Z" }), React.createElement("path", { d: "M12.75 3.065A2.25 2.25 0 0 1 15 5.25v1.585c0 .414.336.75.75.75h1.585A2.25 2.25 0 0 1 19.5 9.75v.75H15a.75.75 0 0 0-.75.75v3.375c0 .414.336.75.75.75h2.25v1.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V9A.75.75 0 0 0 12 8.25H9.75A2.25 2.25 0 0 1 7.5 6V5.25A2.25 2.25 0 0 1 9.75 3h3Z" })));
      const LogoutIcon = (props) => (React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", ...props }, React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: "M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" })));
      const RefreshIcon = (props) => (React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", ...props }, React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: "M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" })));
      const QrCodeIcon = (props) => (React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", ...props }, React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: "M3.75 4.5A.75.75 0 014.5 3.75h4.5a.75.75 0 01.75.75v4.5a.75.75 0 01-.75.75h-4.5a.75.75 0 01-.75-.75v-4.5zM3.75 15A.75.75 0 014.5 14.25h4.5a.75.75 0 01.75.75v4.5a.75.75 0 01-.75.75h-4.5a.75.75 0 01-.75-.75v-4.5zM15 3.75A.75.75 0 0014.25 3h-4.5a.75.75 0 00-.75.75v4.5a.75.75 0 00.75.75h4.5a.75.75 0 00.75-.75v-4.5zM17.25 12.75a.75.75 0 01.75-.75h3a.75.75 0 01.75.75v3a.75.75 0 01-.75.75h-3a.75.75 0 01-.75-.75v-3zM15 17.25a.75.75 0 00-.75.75v1.5a.75.75 0 00.75.75h1.5a.75.75 0 00.75-.75v-1.5a.75.75 0 00-.75-.75h-1.5zM12.75 15a.75.75 0 01.75-.75h1.5a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-1.5a.75.75 0 01-.75-.75v-1.5zM12.75 10.5a.75.75 0 00-.75.75v3a.75.75 0 00.75.75h3a.75.75 0 00.75-.75v-3a.75.75 0 00-.75-.75h-3z" })));
      const LoadingSpinnerIcon = (props) => (React.createElement("svg", { className: "animate-spin -ml-1 mr-3 h-5 w-5 text-sky-500", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", ...props }, React.createElement("circle", { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }), React.createElement("path", { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })));
      // --- END OF INLINED constants.tsx ---

      // --- Firebase Initialization ---
      let firebaseInitialized = false;
      let database = null; // Will hold Firebase database instance

      try {
          if (!window.firebase) {
              throw new Error("Firebase SDK not loaded. Check script tags.");
          }
          if (Object.values(FIREBASE_CONFIG).some(val => val.includes("PLACEHOLDER") || val.includes("YOUR_"))) {
               throw new Error("Firebase config contains placeholder values. Please replace them.");
          }
          if (!firebase.apps.length) {
              firebase.initializeApp(FIREBASE_CONFIG);
              console.log("Desktop: Firebase initialized successfully.");
          } else {
              firebase.app(); 
              console.log("Desktop: Firebase app already initialized.");
          }
          database = firebase.database(); // Get database instance
          firebaseInitialized = true;
      } catch (e) {
          console.error("CRITICAL: Firebase initialization failed!", e);
          const rootEl = document.getElementById('root');
          if (rootEl) {
              rootEl.innerHTML = `
                  <div class="error-message-container">
                      <h2>Firebase 初始化失败 (Firebase Initialization Failed)</h2>
                      <p>请检查 Firebase 配置 (FIREBASE_CONFIG) 是否已在 HTML 文件中正确设置，并且占位符已被真实值替换。</p>
                      <p>Please check if your Firebase configuration (FIREBASE_CONFIG) is correctly set in the HTML file and placeholders are replaced with actual values.</p>
                      <p><strong>错误详情 (Error details):</strong> ${e.message}</p>
                      <p><em>打开浏览器控制台 (F12) 查看更多信息。(Open browser console (F12) for more details.)</em></p>
                  </div>`;
          }
      }
      
      if (GOOGLE_CLIENT_ID.includes("YOUR_GOOGLE_CLIENT_ID") || GOOGLE_CLIENT_ID.includes("PLACEHOLDER")) {
          console.warn("警告: Google Client ID (GOOGLE_CLIENT_ID) 似乎仍是占位符。Google 登录功能可能无法正常工作。请在 mobile.html 和 constants.tsx (如果仍在使用) 中更新它。");
      }
      // --- END OF Firebase Initialization ---

      // --- START OF INLINED firebaseService.ts ---
      const getFirebaseServerTimestamp = () => {
          if (!firebaseInitialized || !firebase.database || !firebase.database.ServerValue) { // Check for firebase.database
            console.warn("Firebase not fully available for ServerValue.TIMESTAMP. Returning client timestamp as fallback.");
            return Date.now(); // Fallback, though not ideal.
          }
          return firebase.database.ServerValue.TIMESTAMP;
      };

      const writeAuthData = async (sessionId, data) => {
          if (!firebaseInitialized || !database) {
            console.error("Firebase not initialized. Cannot write auth data for session:", sessionId);
            throw new Error("Firebase not initialized or database unavailable.");
          }
          try {
              const dataToWrite = {
                  status: data.status || AuthStatus.PENDING,
                  timestamp: getFirebaseServerTimestamp(),
              };
              if (data.token !== undefined) {
                  dataToWrite.token = data.token;
              }
              if (data.error !== undefined) {
                  dataToWrite.error = data.error;
              }
              await database.ref(`${FB_AUTH_PATH}/${sessionId}`).set(dataToWrite);
          } catch (error) {
              console.error("Firebase: 写入授权数据失败 (Error writing auth data to Firebase):", error);
              throw new Error(UI_TEXT.firebaseConnectionError);
          }
      };

      const listenToAuthData = (sessionId, callback) => {
          if (!firebaseInitialized || !database) {
            console.error("Firebase not initialized. Cannot listen to auth data for session:", sessionId);
            // Immediately call callback with an error state or do nothing and let it fail.
            // For now, let component handle this via subsequent errors.
            return () => {}; // Return a no-op unsubscribe function
          }
          const path = `${FB_AUTH_PATH}/${sessionId}`;
          const ref = database.ref(path);
          const listener = ref.on('value', (snapshot) => {
              const data = snapshot.val();
              callback(data);
          }, (error) => {
              console.error("Firebase: 监听授权数据失败 (Error listening to auth data):", error);
              callback({ status: AuthStatus.ERROR, error: UI_TEXT.firebaseConnectionError });
          });
          return () => {
            if (database) ref.off('value', listener); // Check database again for safety
          };
      };

      const deleteAuthData = async (sessionId) => {
          if (!firebaseInitialized || !database) {
            console.warn("Firebase not initialized. Cannot delete auth data for session:", sessionId);
            return; // Don't throw, as it's often a cleanup op.
          }
          try {
              await database.ref(`${FB_AUTH_PATH}/${sessionId}`).remove();
          } catch (error) {
              console.error("Firebase: 删除授权数据失败 (Error deleting auth data from Firebase):", error);
          }
      };

      const generateSessionId = () => {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
              const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
              return v.toString(16);
          });
      };
      // --- END OF INLINED firebaseService.ts ---

      // --- START OF INLINED googleAuthService.ts ---
      const parseIdToken = (idToken) => {
          try {
              const base64Url = idToken.split('.')[1]; 
              if (!base64Url) return null;
              const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
              const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                  return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
              }).join(''));
              const parsed = JSON.parse(jsonPayload);
              if (!parsed.sub || !parsed.email) {
                  console.error("ID token missing 'sub' or 'email' claims.");
                  return null;
              }
              return {
                  id: parsed.sub,
                  name: parsed.name || parsed.given_name,
                  email: parsed.email,
                  picture: parsed.picture,
              };
          } catch (e) {
              console.error("GoogleAuthService: ID 令牌解析失败 (Failed to parse ID token):", e);
              return null;
          }
      };
      const fetchUserProfile = async (idToken) => {
          console.log("GoogleAuthService: 尝试从 ID 令牌解析用户资料 (Attempting to parse user profile from ID token):", idToken ? idToken.substring(0,30) + "..." : "null");
          await new Promise(resolve => setTimeout(resolve, 100)); // Simulate async
          const profile = parseIdToken(idToken);
          if (!profile) {
              console.error("GoogleAuthService: 无效的 ID 令牌或解析失败 (Invalid ID token or failed to parse).");
              throw new Error(UI_TEXT.fetchUserInfoError + " (无效的 ID 令牌或解析错误)");
          }
          console.log("GoogleAuthService: 从 ID 令牌成功提取用户资料 (Successfully extracted user profile from ID token):", profile);
          return profile;
      };
      // --- END OF INLINED googleAuthService.ts ---

      // --- START OF INLINED DesktopPage.tsx ---
      const DesktopPage = () => {
          const [sessionId, setSessionIdState] = useState('');
          const [authStatus, setAuthStatusState] = useState(AuthStatus.INITIALIZING);
          const [userProfile, setUserProfileState] = useState(null);
          const [errorMessage, setErrorMessageState] = useState('');
          const [qrCodeValue, setQrCodeValueState] = useState('');

          const googleServices = [
              { id: 'gmail', name: 'Gmail', url: 'https://mail.google.com/', icon: React.createElement(GmailIcon, { className: "w-10 h-10" }) },
              { id: 'drive', name: 'Drive 云端硬盘', url: 'https://drive.google.com/', icon: React.createElement(DriveIcon, { className: "w-10 h-10" }) },
              { id: 'calendar', name: 'Calendar 日历', url: 'https://calendar.google.com/', icon: React.createElement(CalendarIcon, { className: "w-10 h-10" }) },
              { id: 'docs', name: 'Docs 文档', url: 'https://docs.google.com/', icon: React.createElement(DocsIcon, { className: "w-10 h-10" }) },
          ];

          const initializeNewSession = useCallback(() => {
              if (!firebaseInitialized) {
                  setErrorMessageState(UI_TEXT.firebaseConnectionError + " (未初始化)");
                  setAuthStatusState(AuthStatus.ERROR);
                  return null; // Return null or handle error appropriately
              }
              if (sessionId) {
                  deleteAuthData(sessionId).catch(err => console.warn("未能清理旧会话 (Could not clean up old session):", err));
              }
              const newSessionId = generateSessionId();
              setSessionIdState(newSessionId);
              setUserProfileState(null);
              setErrorMessageState('');
              setAuthStatusState(AuthStatus.PENDING);
              
              const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
              const mobileUrl = `${window.location.origin}${currentPath}/mobile.html#${newSessionId}`;
              setQrCodeValueState(mobileUrl);

              console.log(`Desktop: 新会话 (New session) ID: ${newSessionId}, QR URL: ${mobileUrl}`);
              writeAuthData(newSessionId, { status: AuthStatus.PENDING, timestamp: getFirebaseServerTimestamp() })
                  .catch(error => {
                      console.error("Desktop: 初始化 Firebase 会话失败 (Failed to initialize Firebase session):", error);
                      setErrorMessageState(error.message || UI_TEXT.firebaseConnectionError);
                      setAuthStatusState(AuthStatus.ERROR);
                  });
              return newSessionId;
          }, [sessionId]); // sessionId dependency is important here

          useEffect(() => {
            if (firebaseInitialized) { // Only initialize if Firebase is ready
              initializeNewSession();
            } else {
              // Error message already shown by global init block, or set state here
              setAuthStatusState(AuthStatus.ERROR);
              setErrorMessageState(UI_TEXT.firebaseConnectionError + " (初始化失败)");
            }
             // eslint-disable-next-line react-hooks/exhaustive-deps
          }, [firebaseInitialized]); // Rerun when firebaseInitialized changes

          useEffect(() => {
              if (!firebaseInitialized || !sessionId || authStatus === AuthStatus.INITIALIZING) {
                  return; 
              }
              console.log(`Desktop: 开始监听会话 (Start listening for session) ID: ${sessionId}`);
              const unsubscribe = listenToAuthData(sessionId, async (data) => {
                  if (!data) {
                      if (authStatus !== AuthStatus.PENDING && authStatus !== AuthStatus.LOGGED_OUT && authStatus !== AuthStatus.INITIALIZING) {
                          console.warn(`Desktop: Firebase 数据为空，会话 (Firebase data became null for session) ID ${sessionId}. 可能已过期或被删除 (Possibly expired or deleted).`);
                          setAuthStatusState(AuthStatus.SESSION_EXPIRED);
                          setErrorMessageState(UI_TEXT.statusSessionExpired);
                      }
                      return;
                  }
                  console.log("Desktop: 收到 Firebase 更新 (Received Firebase update):", data);
                  setErrorMessageState(data.error || '');
                  switch (data.status) {
                      case AuthStatus.AUTHORIZED:
                          if (data.token) {
                              setAuthStatusState(AuthStatus.TOKEN_RECEIVED);
                              try {
                                  setAuthStatusState(AuthStatus.FETCHING_USER);
                                  const profile = await fetchUserProfile(data.token);
                                  setUserProfileState(profile);
                                  setAuthStatusState(AuthStatus.USER_INFO_LOADED);
                                  setErrorMessageState(''); 
                              } catch (error) {
                                  console.error("Desktop: 获取用户资料失败 (Failed to fetch user profile):", error);
                                  setErrorMessageState(String(error) || UI_TEXT.fetchUserInfoError);
                                  setAuthStatusState(AuthStatus.ERROR);
                                  setUserProfileState(null);
                              }
                          } else {
                              console.error("Desktop: 状态为 'authorized' 但令牌缺失 (Status is 'authorized' but token is missing).");
                              setErrorMessageState("授权数据不完整 (Incomplete authorization data).");
                              setAuthStatusState(AuthStatus.ERROR);
                          }
                          break;
                      case AuthStatus.PENDING:
                          // Avoid reverting from a more advanced state back to PENDING unless it's a deliberate reset
                          if (authStatus !== AuthStatus.USER_INFO_LOADED && authStatus !== AuthStatus.FETCHING_USER && authStatus !== AuthStatus.TOKEN_RECEIVED && authStatus !== AuthStatus.LOGGED_OUT) {
                              setAuthStatusState(AuthStatus.PENDING);
                          }
                          break;
                      case AuthStatus.ERROR:
                          setAuthStatusState(AuthStatus.ERROR);
                          setUserProfileState(null); // Clear profile on error
                          break;
                      default:
                          // This case might be hit if Firebase data is unusual or status is an old/unexpected value
                          console.log(`Desktop: 未处理的授权状态或 Firebase 数据异常 (Unhandled auth status or unusual Firebase data): ${data.status}`);
                          if (!userProfile && authStatus !== AuthStatus.LOGGED_OUT) { // If no user profile and not explicitly logged out, revert to pending
                             setAuthStatusState(AuthStatus.PENDING); 
                          }
                          break;
                  }
              });
              return () => {
                  console.log(`Desktop: 停止监听会话 (Stop listening for session) ID: ${sessionId}`);
                  unsubscribe();
              };
          }, [sessionId, authStatus, userProfile, firebaseInitialized]); 

          const handleLogoutOrReauthorize = () => {
              console.log("Desktop: 用户登出/重新授权 (User logout/re-authorize)");
              setAuthStatusState(AuthStatus.LOGGED_OUT); 
              if (firebaseInitialized) {
                  initializeNewSession(); 
              } else {
                  setErrorMessageState(UI_TEXT.firebaseConnectionError + " (无法重新授权)");
                  setAuthStatusState(AuthStatus.ERROR);
              }
          };
          
          const getStatusMessage = () => {
              if (errorMessage) return `${UI_TEXT.statusError}: ${errorMessage}`;
              if (!firebaseInitialized && authStatus !== AuthStatus.USER_INFO_LOADED) return UI_TEXT.firebaseConnectionError + " (初始化失败)";
              switch (authStatus) {
                  case AuthStatus.INITIALIZING: return UI_TEXT.statusInitializing;
                  case AuthStatus.PENDING: return UI_TEXT.statusPending;
                  case AuthStatus.TOKEN_RECEIVED: return UI_TEXT.statusTokenReceived;
                  // AuthStatus.AUTHORIZED is mostly a mobile-side or transient server-side status. Desktop moves to FETCHING_USER.
                  case AuthStatus.FETCHING_USER: return UI_TEXT.statusFetchingUser;
                  case AuthStatus.USER_INFO_LOADED: return UI_TEXT.statusUserInfoLoaded;
                  case AuthStatus.LOGGED_OUT: return UI_TEXT.statusLoggedOut;
                  case AuthStatus.SESSION_EXPIRED: return UI_TEXT.statusSessionExpired;
                  case AuthStatus.ERROR: return `${UI_TEXT.statusError}${errorMessage ? ': ' + errorMessage : ''}`; // Error message is already prepended if it exists
                  default: return UI_TEXT.statusPending;
              }
          };

        return (
          React.createElement("div", { className: "container mx-auto max-w-2xl bg-white p-6 sm:p-8 shadow-xl rounded-lg" },
            React.createElement("h2", { className: "text-2xl font-semibold text-center text-sky-700 mb-6" }, DESKTOP_PAGE_TITLE),
            authStatus !== AuthStatus.USER_INFO_LOADED && (
              React.createElement("div", { className: "mb-8 p-6 border border-dashed border-sky-300 rounded-lg bg-sky-50" },
                React.createElement("p", { className: "text-md text-slate-700 mb-4" }, UI_TEXT.scanQrCode),
                qrCodeValue && QRCodeCanvas && firebaseInitialized ? (
                  React.createElement("div", { className: "qr-code-container bg-white p-4 border rounded-md shadow-sm inline-block" },
                    React.createElement(QRCodeCanvas, { value: qrCodeValue, size: 200, level: "M" })
                  )
                ) : (
                  React.createElement("div", { className: "w-[200px] h-[200px] bg-gray-200 flex items-center justify-center rounded-md mx-auto" },
                    React.createElement(QrCodeIcon, { className: "w-16 h-16 text-gray-400" }),
                    (!QRCodeCanvas || !firebaseInitialized) && React.createElement("p", {className: "text-xs text-red-500 mt-1"}, 
                      !firebaseInitialized ? "Firebase 未初始化。" : "QR Code 组件加载失败。"
                    )
                  )
                ),
                React.createElement("p", { className: "mt-4 text-xs text-gray-500 break-all" }, "Session URL: ", qrCodeValue || '生成中 (Generating)...'),
                React.createElement("p", { className: "mt-2 text-xs text-gray-500" }, UI_TEXT.tokenEncryptionNote)
              )
            ),
            React.createElement("div", { className: "mb-6 p-4 border rounded-lg", role: "status", "aria-live": "polite" },
              React.createElement("h3", { className: "text-lg font-medium text-slate-700 mb-2" }, UI_TEXT.authStatus),
              React.createElement("div", { className: "flex items-center" },
                (authStatus === AuthStatus.PENDING || authStatus === AuthStatus.FETCHING_USER || authStatus === AuthStatus.INITIALIZING) && firebaseInitialized && (
                  React.createElement(LoadingSpinnerIcon, { className: "w-5 h-5 mr-2 text-sky-500" })
                ),
                React.createElement("p", { className: `text-md ${authStatus === AuthStatus.ERROR || authStatus === AuthStatus.SESSION_EXPIRED || !firebaseInitialized ? 'text-red-600' : authStatus === AuthStatus.USER_INFO_LOADED ? 'text-green-600' : 'text-slate-600'}` },
                  getStatusMessage()
                )
              )
            ),
            authStatus === AuthStatus.USER_INFO_LOADED && userProfile && firebaseInitialized && (
              React.createElement("div", { className: "animate-fadeIn p-6 border border-green-300 rounded-lg bg-green-50" },
                React.createElement("h3", { className: "text-xl font-semibold text-green-700 mb-4" }, UI_TEXT.userProfile),
                React.createElement("div", { className: "flex items-center space-x-4 mb-6" },
                  userProfile.picture && (
                    React.createElement("img", { src: userProfile.picture, alt: "User profile", className: "w-20 h-20 rounded-full shadow-md border-2 border-white" })
                  ),
                  React.createElement("div", null,
                    React.createElement("p", { className: "text-lg" }, React.createElement("span", { className: "font-medium" }, UI_TEXT.name, ":"), " ", userProfile.name || 'N/A'),
                    React.createElement("p", { className: "text-lg" }, React.createElement("span", { className: "font-medium" }, UI_TEXT.email, ":"), " ", userProfile.email || 'N/A'),
                    userProfile.id && React.createElement("p", { className: "text-sm text-slate-500" }, React.createElement("span", { className: "font-medium" }, UI_TEXT.id, ":"), " ", userProfile.id)
                  )
                ),
                React.createElement("h3", { className: "text-xl font-semibold text-sky-700 mb-4 mt-8" }, UI_TEXT.googleServices),
                React.createElement("div", { className: "grid grid-cols-2 sm:grid-cols-4 gap-4" },
                  googleServices.map(service => (
                    React.createElement("a", {
                      key: service.id,
                      href: service.url,
                      target: "_blank",
                      rel: "noopener noreferrer",
                      className: "service-icon flex flex-col items-center p-4 bg-white hover:bg-sky-50 border border-slate-200 rounded-lg shadow-sm transition-all hover:shadow-md"
                    },
                      React.cloneElement(service.icon, { className: 'w-10 h-10 mb-2 text-sky-600' }),
                      React.createElement("span", { className: "text-sm font-medium text-slate-700" }, service.name)
                    )
                  ))
                )
              )
            ),
            React.createElement("div", { className: "mt-8 flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4" },
              React.createElement("button", {
                onClick: handleLogoutOrReauthorize,
                disabled: !firebaseInitialized,
                className: `w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 ${!firebaseInitialized ? 'opacity-50 cursor-not-allowed' : ''}`
              },
                React.createElement(LogoutIcon, { className: "w-5 h-5 mr-2" }),
                authStatus === AuthStatus.USER_INFO_LOADED ? UI_TEXT.logout : UI_TEXT.reauthorize
              ),
              (authStatus === AuthStatus.ERROR || authStatus === AuthStatus.SESSION_EXPIRED) && firebaseInitialized && (
                React.createElement("button", {
                  onClick: handleLogoutOrReauthorize,
                  className: "w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75"
                },
                  React.createElement(RefreshIcon, { className: "w-5 h-5 mr-2" }),
                  UI_TEXT.reauthorize
                )
              )
            )
          )
        );
      };
      // --- END OF INLINED DesktopPage.tsx ---

      // Wrapper App component
      const AppDesktop = () => {
        return (
          React.createElement("div", { className: "min-h-screen bg-slate-100 text-slate-800" },
            React.createElement("header", { className: "bg-sky-600 text-white p-4 shadow-md" },
              React.createElement("h1", { className: "text-2xl font-semibold text-center" }, APP_TITLE)
            ),
            React.createElement("main", { className: "p-4 sm:p-6" },
              firebaseInitialized ? React.createElement(DesktopPage, null) : null // Only render if Firebase init was successful
            ),
            React.createElement("footer", { className: "text-center p-4 text-sm text-slate-500 mt-8" },
              React.createElement("p", null, "\u00a9 ", new Date().getFullYear(), " 跨设备授权演示 (Cross-Device Auth Demo)")
            )
          )
        );
      };

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        // This error is critical and means the HTML structure is broken.
        console.error("CRITICAL: Root element with ID 'root' not found in HTML.");
        document.body.innerHTML = "<div class='error-message-container'><h2>发生严重错误 (Critical Error)</h2><p>无法找到页面挂载点 (Could not find page mount point 'root'). HTML 结构可能已损坏。</p></div>";
      } else if (firebaseInitialized) { // Only attempt to render React app if Firebase successfully initialized
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          React.createElement(StrictMode, null, React.createElement(AppDesktop, null))
        );
      } else {
        // Error message for Firebase init failure is already in #root from the catch block.
        console.log("React rendering skipped due to Firebase initialization failure.");
      }
    </script>
</body>
</html>
