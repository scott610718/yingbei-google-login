<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電腦端 - Google 整合應用</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        #qrcode { margin: 20px 0; }
        .status { margin: 20px 0; padding: 10px; border-radius: 4px; }
        .waiting { background-color: #f0f0f0; }
        .success { background-color: #d4edda; color: #155724; }
        .error   { background-color: #f8d7da; color: #721c24; }
        button { padding: 10px 20px; background-color: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #debug { margin-top: 20px; padding: 10px; background-color: #f8f9fa; border: 1px solid #ddd; text-align: left; font-family: monospace; max-height: 150px; overflow-y: auto; display: none; }
        .user-profile { display: none; margin: 20px 0; text-align: center; }
        .profile-image { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; }
        .user-actions { margin-top: 20px; }
        .welcome-message { margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; max-width: 600px; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>電腦端 - Google 整合應用</h1>
        <div id="statusContainer" class="status waiting">
            <p id="statusMessage">請使用手機掃描下方 QR Code</p>
        </div>

        <!-- 初始畫面：QR Code 掃描區 -->
        <div id="qrcode-container">
            <div id="qrcode"></div>
        </div>

        <!-- 用戶登入成功後顯示資訊 -->
        <div id="user-profile" class="user-profile">
            <img id="profile-image" class="profile-image" src="" alt="用戶頭像">
            <h2 id="user-name">用戶名稱</h2>
            <p id="user-email">用戶郵箱</p>
        </div>

        <!-- 歡迎訊息 -->
        <div id="welcome-message" class="welcome-message">
            <h2>登入成功！</h2>
            <p>您已成功使用 Google 帳號完成登入。</p>
            <p>您現在可以使用完整的 Google 服務，無需再次輸入密碼。</p>
            <p>請點擊下方按鈕開啟 Google 服務。</p>
            <!-- 改為呼叫 openGoogleService -->
            <button onclick="openGoogleService()">開啟 Google</button>
        </div>

        <!-- 用戶操作按鈕 -->
        <div id="user-actions" class="user-actions" style="display:none;">
            <button id="logoutBtn" onclick="logout()">登出</button>
        </div>

        <div id="debug"></div>
        <button id="showDebugBtn" style="margin-top: 20px; background-color: #6c757d;">顯示除錯資訊</button>
    </div>

    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyArF8xncLwA3osSQ_o6yWIyuOc0TMrXRTY",
            authDomain: "yingpei--login.firebaseapp.com",
            databaseURL: "https://yingpei--login-default-rtdb.firebaseio.com",
            projectId: "yingpei--login",
            storageBucket: "yingpei--login.firebasestorage.app",
            messagingSenderId: "261477282402",
            appId: "1:261477282402:web:557f0be058e07cd642173b",
            measurementId: "G-EB9PR17TJL"
        };
        const googleClientId = "130403455153-cdmr57ri7qh3s6c8riul6q6hsi3arjf8.apps.googleusercontent.com";

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let googleCredential = null;
        let googleUserInfo = null;

        function log(message) {
            const debug = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            debug.innerHTML += `[${time}] ${message}\n`;
            debug.scrollTop = debug.scrollHeight;
            console.log(message);
        }
        function updateStatus(msg, type) {
            const sc = document.getElementById('statusContainer');
            sc.className = `status ${type}`;
            document.getElementById('statusMessage').textContent = msg;
            log(`狀態更新: ${msg}`);
        }

        function generateSessionId() {
            return 'session_' + Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
        }
        function generateQRCode(text) {
            const qr = qrcode(0, 'L');
            qr.addData(text); qr.make();
            document.getElementById('qrcode').innerHTML = qr.createImgTag(6);
        }

        function listenForAuthToken(sessionId) {
            const sessionRef = database.ref('sessions/' + sessionId);
            log(`監聽 sessions/${sessionId}`);
            sessionRef.on('value', snap => {
                const data = snap.val();
                if (data && data.credential) {
                    googleCredential = data.credential;
                    updateStatus('已接收到 Google 登入憑證', 'success');
                    const payload = parseJwt(googleCredential);
                    googleUserInfo = { name: payload.name, email: payload.email, picture: payload.picture };
                    displayUserProfile(googleUserInfo);
                    document.getElementById('welcome-message').style.display = 'block';
                    document.getElementById('user-actions').style.display = 'block';
                    document.getElementById('qrcode-container').style.display = 'none';
                    // 刪除 session 防重放
                    sessionRef.remove().catch(e => log(`刪除 session 失敗: ${e.message}`));
                }
            });
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const json = atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('');
                return JSON.parse(decodeURIComponent(json));
            } catch (e) {
                log(`JWT 解析錯誤: ${e.message}`); return {};
            }
        }

        function displayUserProfile(user) {
            document.getElementById('profile-image').src = user.picture;
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-profile').style.display = 'block';
        }

        function openGoogleService() {
            if (!googleCredential) {
                alert('尚未取得 Google 登入憑證');
                return;
            }
            // 在新視窗中先載入 GSI iframe 登錄，用以為 .google.com 設置 Cookie
            const loginUrl = `https://accounts.google.com/gsi/iframe?client_id=${googleClientId}&credential=${googleCredential}`;
            const win = window.open(loginUrl, '_blank', 'width=600,height=600');
            // 3 秒後導向到 google.com
            setTimeout(() => {
                win.location.href = 'https://www.google.com';
            }, 3000);
        }

        function logout() {
            googleCredential = null;
            googleUserInfo = null;
            document.getElementById('user-profile').style.display = 'none';
            document.getElementById('welcome-message').style.display = 'none';
            document.getElementById('user-actions').style.display = 'none';
            document.getElementById('qrcode-container').style.display = 'block';
            updateStatus('已登出，請重新掃描 QR Code', 'waiting');
            initializePage();
        }

        function initializePage() {
            const sessionId = generateSessionId();
            localStorage.setItem('currentSessionId', sessionId);
            const qrData = JSON.stringify({ sessionId, action: 'googleAuth' });
            generateQRCode(qrData);
            updateStatus('請掃描 QR Code 進行授權', 'waiting');
            listenForAuthToken(sessionId);
        }

        window.onload = () => {
            // 測試 Firebase 連線
            database.ref('test').set({ timestamp: Date.now(), message: 'ping' })
                .then(() => log('Firebase 連線正常'))
                .catch(e => log(`Firebase 測試失敗: ${e.message}`));
            initializePage();
            document.getElementById('showDebugBtn').addEventListener('click', () => {
                const dbg = document.getElementById('debug');
                dbg.style.display = dbg.style.display === 'none' ? 'block' : 'none';
                document.getElementById('showDebugBtn').textContent = dbg.style.display === 'none' ? '顯示除錯資訊' : '隱藏除錯資訊';
            });
        };
    </script>
</body>
</html>
