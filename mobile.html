<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google 登入 - 手機端</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }
        h1 {
            color: #4285F4;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        .btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        .btn:disabled {
            background-color: #cccccc;
        }
        .google-btn {
            background-color: white;
            color: #757575;
            border: 1px solid #ddd;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .google-btn img {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        #status {
            margin-top: 20px;
            text-align: center;
        }
        .success {
            color: #0f9d58;
        }
        .error {
            color: #ea4335;
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo img {
            height: 30px;
        }
        #qrScanner {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_92x30dp.png" alt="Google Logo">
        </div>
        <h1>登入您的 Google 帳號</h1>
        
        <div id="userForm">
            <div class="form-group">
                <label for="name">姓名</label>
                <input type="text" id="name" placeholder="請輸入您的姓名">
            </div>
            
            <div id="qrScanner">
                <p>掃描 QR Code 或手動輸入會話 ID:</p>
                <div class="form-group">
                    <label for="sessionId">會話 ID</label>
                    <input type="text" id="sessionId" placeholder="輸入會話 ID">
                </div>
                <button onclick="openScanner()" class="btn">開啟相機掃描 QR Code</button>
            </div>
            
            <button id="connectBtn" class="btn" onclick="connectToComputer()">連接至電腦</button>
        </div>
        
        <div id="googleAuthUI" style="display: none;">
            <p>請使用 Google 帳號登入，以授權您的電腦：</p>
            <button id="googleSignInBtn" class="google-btn" onclick="signInWithGoogle()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google Logo">
                使用 Google 帳號登入
            </button>
        </div>
        
        <div id="status"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <script src="https://apis.google.com/js/api:client.js"></script>
    <script>
        // Firebase 配置 (與電腦端相同)
        const firebaseConfig = {
            apiKey: "AIzaSyArF8xncLwA3osSQ_o6yWIyuOc0TMrXRTY",
            authDomain: "yingpei--login.firebaseapp.com",
            databaseURL: "https://yingpei--login-default-rtdb.firebaseio.com",
            projectId: "yingpei--login",
            storageBucket: "yingpei--login.firebasestorage.app",
            messagingSenderId: "261477282402",
            appId: "1:261477282402:web:557f0be058e07cd642173b",
            measurementId: "G-EB9PR17TJL"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // 從 URL 獲取會話 ID (如果有)
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');
        if (sessionId) {
            document.getElementById('sessionId').value = sessionId;
        }
        
        // 初始化 Google Sign-In API
        gapi.load('auth2', function() {
            gapi.auth2.init({
                client_id: '130403455153-cdmr57ri7qh3s6c8riul6q6hsi3arjf8.apps.googleusercontent.com',
                scope: 'profile email',
                ux_mode: 'redirect',
                redirect_uri: window.location.href
            });
        });
        
        // 開啟相機掃描 QR Code
        function openScanner() {
            const sessionId = document.getElementById('sessionId').value;
            if (sessionId) {
                // 如果已有會話 ID，則更新掃描狀態
                const sessionRef = database.ref(`sessions/${sessionId}`);
                sessionRef.update({ status: 'scanning' });
            }
            
            // 創建 QR 掃描器 UI
            const scannerDiv = document.createElement('div');
            scannerDiv.id = 'qrCodeScanner';
            scannerDiv.style.width = '100%';
            scannerDiv.style.marginTop = '20px';
            document.getElementById('qrScanner').appendChild(scannerDiv);
            
            const closeButton = document.createElement('button');
            closeButton.innerText = '關閉掃描器';
            closeButton.className = 'btn';
            closeButton.style.backgroundColor = '#ea4335';
            closeButton.onclick = function() {
                html5QrCode.stop();
                document.getElementById('qrScanner').removeChild(scannerDiv);
                document.getElementById('qrScanner').removeChild(closeButton);
            };
            document.getElementById('qrScanner').appendChild(closeButton);
            
            // 初始化 QR 掃描器
            const html5QrCode = new Html5Qrcode("qrCodeScanner");
            const qrCodeSuccessCallback = (decodedText) => {
                try {
                    const url = new URL(decodedText);
                    const params = new URLSearchParams(url.search);
                    const scannedSessionId = params.get('session');
                    
                    if (scannedSessionId) {
                        document.getElementById('sessionId').value = scannedSessionId;
                        
                        // 更新掃描狀態
                        const sessionRef = database.ref(`sessions/${scannedSessionId}`);
                        sessionRef.update({ status: 'scanning' });
                        
                        html5QrCode.stop();
                        document.getElementById('qrScanner').removeChild(scannerDiv);
                        document.getElementById('qrScanner').removeChild(closeButton);
                    }
                } catch (e) {
                    console.error("非有效的網址格式", e);
                }
            };
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
        }
        
        // 連接到電腦
        function connectToComputer() {
            const sessionId = document.getElementById('sessionId').value;
            const name = document.getElementById('name').value;
            
            if (!sessionId) {
                alert('請輸入會話 ID 或掃描 QR Code');
                return;
            }
            
            if (!name) {
                alert('請輸入您的姓名');
                return;
            }
            
            const sessionRef = database.ref(`sessions/${sessionId}`);
            
            // 檢查會話是否存在且未過期
            sessionRef.once('value')
                .then((snapshot) => {
                    const sessionData = snapshot.val();
                    
                    if (!sessionData) {
                        showStatus('會話不存在或已過期，請重新掃描 QR Code', 'error');
                        return;
                    }
                    
                    if (sessionData.expiresAt < Date.now()) {
                        showStatus('會話已過期，請重新掃描 QR Code', 'error');
                        return;
                    }
                    
                    // 隱藏表單，顯示 Google 登入介面
                    document.getElementById('userForm').style.display = 'none';
                    document.getElementById('googleAuthUI').style.display = 'block';
                    
                    // 儲存會話信息
                    window.currentSessionId = sessionId;
                    window.userName = name;
                    
                    // 更新連接狀態
                    return sessionRef.update({
                        status: 'connected',
                        mobileInfo: {
                            displayName: name,
                            connectedAt: Date.now()
                        }
                    });
                })
                .catch((error) => {
                    console.error(error);
                    showStatus(`發生錯誤: ${error.message}`, 'error');
                });
        }
        
        // 使用 Google 登入
        function signInWithGoogle() {
            if (!window.currentSessionId) {
                showStatus('未找到有效會話，請重新連接', 'error');
                return;
            }
            
            const sessionRef = database.ref(`sessions/${window.currentSessionId}`);
            
            // 更新狀態為驗證中
            sessionRef.update({ status: 'authenticating' });
            
            // 獲取 Google Auth 實例
            const auth2 = gapi.auth2.getAuthInstance();
            
            // 進行 Google 登入
            auth2.grantOfflineAccess({ prompt: 'consent' }).then(function(response) {
                if (response.code) {
                    // 獲取授權碼成功
                    // 將授權碼發送到 Firebase
                    sessionRef.update({
                        status: 'authorized',
                        authCode: response.code,
                        authorizedAt: Date.now()
                    });
                    
                    // 顯示成功訊息
                    showStatus('已授權成功！請返回電腦查看登入狀態', 'success');
                    
                    // 監聽電腦端登入完成狀態
                    sessionRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data && data.status === 'completed') {
                            showStatus('電腦端已完成登入，您可以關閉此頁面', 'success');
                        } else if (data && data.status === 'error') {
                            showStatus(`登入失敗: ${data.error}`, 'error');
                            // 顯示表單，允許重試
                            document.getElementById('userForm').style.display = 'block';
                            document.getElementById('googleAuthUI').style.display = 'none';
                        }
                    });
                }
            }).catch(function(error) {
                console.error('Google Sign-In Error:', error);
                showStatus(`Google 登入失敗: ${error.error}`, 'error');
                sessionRef.update({ status: 'error', error: error.error || '授權失敗' });
                
                // 顯示表單，允許重試
                document.getElementById('userForm').style.display = 'block';
                document.getElementById('googleAuthUI').style.display = 'none';
            });
        }
        
        // 顯示狀態訊息
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.innerText = message;
            statusElement.className = type;
        }
    </script>
</body>
</html>
